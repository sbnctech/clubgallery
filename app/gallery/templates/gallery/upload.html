<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Photos - SBNC</title>

    <!-- WA Widget Styles - will be overridden when embedded in WA -->
    <link rel="stylesheet" href="https://sbnewcomers.org/resources/Theme/SantaBarbaraNewcomersClubTheme/widget.css" onerror="">

    <style>
        /* CSS Custom Properties - will inherit from WA theme when embedded */
        :root {
            --wa-primary-color: #2c5aa0;
            --wa-secondary-color: #d4a800;
            --wa-text-color: #333;
            --wa-text-muted: #666;
            --wa-bg-light: #f5f5f5;
            --wa-border-color: #ddd;
            --wa-success-color: #27ae60;
            --wa-error-color: #e74c3c;
        }
        * { box-sizing: border-box; }

        /* Base styles - these will be overridden when embedded in WA */
        body {
            font-family: inherit;
            margin: 0;
            padding: 20px;
            background-color: var(--wa-bg-light);
            color: var(--wa-text-color);
            line-height: 1.5;
        }

        /* When embedded in WA, remove padding */
        .wa-embedded body {
            padding: 0;
            background: transparent;
        }

        .upload-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
        }

        /* Remove shadow when embedded */
        body:not(.wa-embedded) .upload-container {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1, h2, h3 {
            font-family: inherit;
            color: var(--wa-primary-color);
        }
        h1 {
            margin: 0 0 10px;
            font-size: 28px;
        }
        h2 {
            font-size: 22px;
        }
        h3 {
            font-size: 18px;
            margin: 0 0 15px;
        }
        .subtitle {
            color: var(--wa-text-muted);
            margin-bottom: 30px;
        }

        /* WA-style links */
        a {
            color: var(--wa-primary-color);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* WA-style inputs */
        input[type="text"],
        input[type="email"],
        select {
            font-family: inherit;
            font-size: 14px;
            padding: 10px 12px;
            border: 1px solid var(--wa-border-color);
            border-radius: 4px;
            width: 100%;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        select:focus {
            outline: none;
            border-color: var(--wa-primary-color);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.1);
        }

        /* WA-style buttons */
        .btn-primary {
            display: inline-block;
            padding: 12px 24px;
            background: var(--wa-primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-primary:hover {
            opacity: 0.9;
            text-decoration: none;
        }
        .btn-secondary {
            display: inline-block;
            padding: 10px 20px;
            background: var(--wa-secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
        }

        /* Option boxes */
        .option-box {
            flex: 1;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid;
        }
        .option-box.email {
            background: #f0f7ff;
            border-color: var(--wa-primary-color);
        }
        .option-box.upload {
            background: #fffbf0;
            border-color: var(--wa-secondary-color);
        }
        .option-box h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .option-box.email h3 { color: var(--wa-primary-color); }
        .option-box.upload h3 { color: #8b7000; }

        .shrinkwrap-notice {
            background: white;
            border-radius: 4px;
            padding: 12px;
            border-left: 3px solid var(--wa-primary-color);
            font-size: 13px;
            color: var(--wa-text-muted);
        }

        /* Drop zone */
        .drop-zone {
            border: 3px dashed var(--wa-border-color);
            border-radius: 8px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--wa-primary-color);
            background: #f0f7ff;
        }
        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .drop-zone-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        .drop-zone-hint {
            font-size: 14px;
            color: #888;
        }

        /* File input */
        .file-input {
            display: none;
        }

        /* Event selection */
        .event-select {
            margin-bottom: 20px;
        }
        .event-select label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .event-select select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        /* Preview */
        .preview-container {
            display: none;
        }
        .preview-container.has-files {
            display: block;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .preview-header h3 {
            margin: 0;
            color: #333;
        }
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 5px;
            overflow: hidden;
            background: #f0f0f0;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 24px;
            text-align: center;
        }
        .preview-item .remove:hover {
            background: #e74c3c;
        }
        .preview-item .status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 5px;
            text-align: center;
            font-size: 12px;
        }
        .preview-item .status.pending {
            background: rgba(255,193,7,0.9);
            color: #333;
        }
        .preview-item .status.uploading {
            background: rgba(33,150,243,0.9);
            color: white;
        }
        .preview-item .status.success {
            background: rgba(76,175,80,0.9);
            color: white;
        }
        .preview-item .status.error {
            background: rgba(244,67,54,0.9);
            color: white;
        }

        /* Upload button */
        .btn-upload {
            width: 100%;
            padding: 15px;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        .btn-upload:hover {
            background: #244a85;
        }
        .btn-upload:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Progress */
        .upload-progress {
            margin-top: 20px;
            display: none;
        }
        .upload-progress.visible {
            display: block;
        }
        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: #666;
        }

        /* Success message */
        .success-message {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .success-message.visible {
            display: block;
        }
        .success-icon {
            font-size: 64px;
            color: #27ae60;
            margin-bottom: 15px;
        }
        .success-message h2 {
            color: #333;
            margin: 0 0 10px;
        }
        .success-message p {
            color: #666;
            margin-bottom: 20px;
        }
        .btn-new-upload {
            padding: 12px 30px;
            background: white;
            color: #2c5aa0;
            border: 2px solid #2c5aa0;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
        }

        /* Form section */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--wa-text-color);
        }
        .form-group .required {
            color: var(--wa-error-color);
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--wa-text-muted);
            font-size: 13px;
        }

        /* Autocomplete suggestions */
        .suggestions-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--wa-border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:hover {
            background: #f0f7ff;
        }
        .selected-item {
            display: none;
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 4px;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .selected-item.event {
            background: #e3f2fd;
            color: #1565c0;
        }
        .selected-item .clear-btn {
            float: right;
            background: none;
            border: none;
            color: var(--wa-error-color);
            cursor: pointer;
            font-size: 13px;
        }

        /* Media Rights / Consent */
        .media-rights {
            background: #fffbf0;
            border: 1px solid #f0e0a0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .media-rights h3 {
            color: #8b7000;
            margin: 0 0 12px;
            font-size: 16px;
        }
        .media-rights ul {
            font-size: 14px;
            line-height: 1.6;
            margin: 0 0 15px;
            padding-left: 20px;
        }
        .media-rights li {
            margin-bottom: 6px;
        }
        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding-top: 12px;
            border-top: 1px solid #e0d8b0;
        }
        .consent-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--wa-primary-color);
        }
        .consent-checkbox label {
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            line-height: 1.4;
        }

        .drop-zone.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="upload-container">
    <div id="upload-form">
        <h1>Share Your Photos</h1>
        <p class="subtitle">Help us capture SBNC memories</p>

        <!-- Photo Guidelines - applies to both submission methods -->
        <div class="photo-guidelines" style="background: #fff8e1; border: 1px solid #f0e0a0; border-radius: 8px; padding: 15px 20px; margin-bottom: 25px;">
            <p style="margin: 0 0 10px; font-weight: 500; color: #8b7000;"><strong>Please do not submit photos that:</strong></p>
            <ul style="margin: 0; padding-left: 20px; line-height: 1.7; color: #555;">
                <li>Could embarrass or cause discomfort to individuals pictured</li>
                <li>Show people in unflattering situations</li>
                <li>Individuals have asked not to be shared</li>
            </ul>
        </div>

        <!-- Two Options -->
        <div class="options-container" style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;">

            <!-- Option 1: Email -->
            <div class="option-box email" style="flex: 1.5;">
                <h3><span style="font-size: 24px;">üìß</span> Option 1: Email Your Photos</h3>
                <p>The quickest way - full quality photos, no compression!</p>

                <div style="background: white; border-radius: 6px; padding: 15px; margin: 15px 0;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <a href="mailto:photos@sbnewcomers.org" style="display: inline-block; background: var(--wa-primary-color); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 16px;">
                            üìß Email photos@sbnewcomers.org
                        </a>
                    </div>
                    <p style="text-align: center; margin: 0; color: #666; font-size: 14px;">
                        Include the <strong>event name</strong> in the subject line
                    </p>
                </div>

                <!-- Device-specific instructions -->
                <div style="margin-top: 15px;">
                    <p style="font-weight: 600; margin-bottom: 10px; color: #333;">How to email photos from your device:</p>

                    <!-- iOS/iPhone -->
                    <details style="margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                        <summary style="padding: 12px 15px; cursor: pointer; font-weight: 500; color: #333;">
                            üçé iPhone / iPad
                        </summary>
                        <div style="padding: 0 15px 15px; font-size: 14px; line-height: 1.7; color: #555;">
                            <p><strong>From the Photos app:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Open <strong>Photos</strong> and select the photos you want</li>
                                <li>Tap the <strong>Share</strong> button (square with arrow)</li>
                                <li>Tap <strong>Mail</strong></li>
                                <li>Enter <strong>photos@sbnewcomers.org</strong></li>
                                <li>Add event name to subject line</li>
                                <li>When asked about size, choose <strong>"Actual Size"</strong> for best quality</li>
                                <li>Tap <strong>Send</strong></li>
                            </ol>
                            <p style="margin-top: 10px; padding: 8px; background: #f0f7ff; border-radius: 4px;">
                                <strong>Tip:</strong> You can select multiple photos by tapping "Select" then tapping each photo.
                            </p>
                        </div>
                    </details>

                    <!-- Android -->
                    <details style="margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                        <summary style="padding: 12px 15px; cursor: pointer; font-weight: 500; color: #333;">
                            ü§ñ Android Phone / Tablet
                        </summary>
                        <div style="padding: 0 15px 15px; font-size: 14px; line-height: 1.7; color: #555;">
                            <p><strong>From Google Photos or Gallery:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Open your <strong>Photos</strong> or <strong>Gallery</strong> app</li>
                                <li>Long-press a photo to select, then tap others to add</li>
                                <li>Tap the <strong>Share</strong> icon</li>
                                <li>Choose <strong>Gmail</strong> or your email app</li>
                                <li>Enter <strong>photos@sbnewcomers.org</strong></li>
                                <li>Add event name to subject line</li>
                                <li>Tap <strong>Send</strong></li>
                            </ol>
                            <p style="margin-top: 10px; padding: 8px; background: #f0f7ff; border-radius: 4px;">
                                <strong>Tip:</strong> If asked about size, choose "Original" or "Full size" for best quality.
                            </p>
                        </div>
                    </details>

                    <!-- Mac -->
                    <details style="margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                        <summary style="padding: 12px 15px; cursor: pointer; font-weight: 500; color: #333;">
                            üíª Mac Computer
                        </summary>
                        <div style="padding: 0 15px 15px; font-size: 14px; line-height: 1.7; color: #555;">
                            <p><strong>From Photos app:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Open <strong>Photos</strong> and select your photos (Cmd+click for multiple)</li>
                                <li>Click <strong>File</strong> ‚Üí <strong>Share</strong> ‚Üí <strong>Mail</strong></li>
                                <li>Or right-click and choose <strong>Share</strong> ‚Üí <strong>Mail</strong></li>
                                <li>Enter <strong>photos@sbnewcomers.org</strong></li>
                                <li>Add event name to subject line</li>
                                <li>Click <strong>Send</strong></li>
                            </ol>
                            <p><strong>From Finder:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Select photo files in Finder</li>
                                <li>Right-click ‚Üí <strong>Share</strong> ‚Üí <strong>Mail</strong></li>
                                <li>Or drag files directly into a new email</li>
                            </ol>
                        </div>
                    </details>

                    <!-- Windows -->
                    <details style="margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                        <summary style="padding: 12px 15px; cursor: pointer; font-weight: 500; color: #333;">
                            ü™ü Windows PC
                        </summary>
                        <div style="padding: 0 15px 15px; font-size: 14px; line-height: 1.7; color: #555;">
                            <p><strong>From File Explorer:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Open <strong>File Explorer</strong> and find your photos</li>
                                <li>Select photos (Ctrl+click for multiple)</li>
                                <li>Right-click ‚Üí <strong>Share</strong> ‚Üí <strong>Mail</strong></li>
                                <li>Or open your email and drag photos into a new message</li>
                                <li>Enter <strong>photos@sbnewcomers.org</strong></li>
                                <li>Add event name to subject line</li>
                                <li>Click <strong>Send</strong></li>
                            </ol>
                            <p><strong>From Photos app:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Open <strong>Photos</strong> app</li>
                                <li>Select photos and click <strong>Share</strong> ‚Üí <strong>Mail</strong></li>
                            </ol>
                        </div>
                    </details>

                    <!-- Web Email -->
                    <details style="margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                        <summary style="padding: 12px 15px; cursor: pointer; font-weight: 500; color: #333;">
                            üåê Gmail / Web Email
                        </summary>
                        <div style="padding: 0 15px 15px; font-size: 14px; line-height: 1.7; color: #555;">
                            <ol style="margin: 0; padding-left: 20px;">
                                <li>Go to <strong>gmail.com</strong> (or your email provider)</li>
                                <li>Click <strong>Compose</strong></li>
                                <li>Enter <strong>photos@sbnewcomers.org</strong></li>
                                <li>Add event name to subject line</li>
                                <li>Click the <strong>üìé attachment</strong> icon (paperclip)</li>
                                <li>Select your photo files</li>
                                <li>Click <strong>Send</strong></li>
                            </ol>
                            <p style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px;">
                                <strong>Note:</strong> Gmail allows up to 25MB per email. For many photos, send multiple emails.
                            </p>
                        </div>
                    </details>
                </div>

                <div class="shrinkwrap-notice" style="margin-top: 15px;">
                    <strong>By emailing photos</strong>, you acknowledge SBNC's media release policy
                    (which you agreed to when joining) and confirm the photos are appropriate for sharing.
                </div>
            </div>

            <!-- Option 2: Upload -->
            <div class="option-box upload">
                <h3><span style="font-size: 24px;">üì§</span> Option 2: Upload Here</h3>
                <p>Best for uploading many photos at once.</p>
                <ul style="padding-left: 20px; line-height: 1.8;">
                    <li>Drag and drop or browse</li>
                    <li>Select event from list</li>
                    <li>Track upload progress</li>
                </ul>
                <p style="margin: 15px 0 0; text-align: center;">
                    <button type="button" onclick="showUploadForm()" class="btn-secondary">Go to Upload Form ‚Üì</button>
                </p>
            </div>
        </div>

        <!-- Upload Form Section (hidden by default) -->
        <div id="upload-section" style="display: none; border-top: 2px solid #eee; margin: 30px 0; padding-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Upload Photos</h2>
                <button type="button" onclick="hideUploadForm()" style="background: none; border: none; color: #888; cursor: pointer; font-size: 14px;">‚úï Close</button>
            </div>

        <!-- Submitter Info -->
        <div class="form-group" style="position: relative;">
            <label for="submitter-search">Your Name <span class="required">*</span></label>
            <input type="text" id="submitter-search" placeholder="Start typing your name..." autocomplete="off">
            <input type="hidden" id="submitter-member-id">
            <input type="hidden" id="submitter-name">
            <input type="hidden" id="submitter-email">
            <div id="member-suggestions" class="suggestions-dropdown"></div>
            <div id="selected-member" class="selected-item">
                <span id="selected-member-text"></span>
                <button type="button" onclick="clearMember()" class="clear-btn">Change</button>
            </div>
        </div>

        <!-- Event Selection -->
        <div class="form-group" style="position: relative;">
            <label for="event-search">Event (optional)</label>
            <input type="text" id="event-search" placeholder="Start typing event name or date..." autocomplete="off">
            <input type="hidden" id="event-id">
            <div id="event-suggestions" class="suggestions-dropdown" style="max-height: 250px;"></div>
            <div id="selected-event" class="selected-item event">
                <span id="selected-event-text"></span>
                <button type="button" onclick="clearEvent()" class="clear-btn">Clear</button>
            </div>
            <small>Can't find your event? Leave blank and we'll match it from the photo date.</small>
        </div>

        <!-- Consent Checkbox -->
        <div class="media-rights" style="padding: 15px 20px;">
            <div class="consent-checkbox" style="border-top: none; padding-top: 0;">
                <input type="checkbox" id="consent-checkbox">
                <label for="consent-checkbox">I confirm these photos are appropriate for sharing and acknowledge SBNC's media release policy</label>
            </div>
        </div>

        <!-- Drop Zone -->
        <div class="drop-zone disabled" id="drop-zone">
            <div class="drop-zone-icon">üì∑</div>
            <div class="drop-zone-text">Drag and drop photos here</div>
            <div class="drop-zone-hint">or click to browse</div>
            <div class="drop-zone-hint" style="font-size: 12px; margin-top: 5px;">JPG, PNG, HEIC, TIFF, WebP, and RAW files (Nikon, Canon, Sony, etc.)</div>
            <div class="drop-zone-hint" id="consent-reminder" style="color: #c00; margin-top: 10px;">Please agree to the terms above to enable uploads</div>
        </div>
        <input type="file" id="file-input" class="file-input" multiple accept="image/jpeg,image/png,image/heic,image/heif,image/tiff,image/webp,image/bmp,.nef,.nrw,.cr2,.cr3,.arw,.raf,.orf,.rw2,.pef,.dng,.raw">

        <!-- Preview -->
        <div class="preview-container" id="preview-container">
            <div class="preview-header">
                <h3>Selected Photos (<span id="file-count">0</span>)</h3>
                <button type="button" onclick="clearFiles()" style="background: none; border: none; color: #e74c3c; cursor: pointer;">Clear All</button>
            </div>
            <div class="preview-grid" id="preview-grid"></div>
            <button type="button" class="btn-upload" id="upload-btn" onclick="uploadFiles()">Upload Photos</button>
        </div>

        <!-- Progress -->
        <div class="upload-progress" id="upload-progress">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Uploading...</div>
        </div>
        </div><!-- End upload-section -->
    </div>

    <!-- Success Message -->
    <div class="success-message" id="success-message">
        <div class="success-icon">‚úì</div>
        <h2>Photos Uploaded!</h2>
        <p id="success-text">Your photos have been submitted for review.</p>
        <a href="javascript:resetForm()" class="btn-new-upload">Upload More Photos</a>
    </div>
</div>

<script>
let selectedFiles = [];
let consentGiven = false;

// Show/hide upload form section
function showUploadForm() {
    document.getElementById('upload-section').style.display = 'block';
    document.getElementById('upload-section').scrollIntoView({behavior: 'smooth'});
}

function hideUploadForm() {
    document.getElementById('upload-section').style.display = 'none';
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// Consent checkbox handling
const consentCheckbox = document.getElementById('consent-checkbox');
const consentReminder = document.getElementById('consent-reminder');

consentCheckbox.addEventListener('change', function() {
    consentGiven = this.checked;
    const dropZone = document.getElementById('drop-zone');

    if (consentGiven) {
        dropZone.classList.remove('disabled');
        consentReminder.style.display = 'none';
    } else {
        dropZone.classList.add('disabled');
        consentReminder.style.display = 'block';
        // Clear any selected files if consent is revoked
        if (selectedFiles.length > 0) {
            clearFiles();
        }
    }
});

// Member data cache
let memberList = [];
let selectedMemberId = null;

// Load member list for autocomplete
fetch('/api/members.json')
    .then(r => r.json())
    .then(members => {
        memberList = members;
        console.log(`Loaded ${members.length} members for autocomplete`);
    })
    .catch(e => console.log('Member list not available - will use WA context'));

// Member search autocomplete
const searchInput = document.getElementById('submitter-search');
const suggestionsDiv = document.getElementById('member-suggestions');

searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();

    if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }

    // Filter members matching the query
    const matches = memberList.filter(m =>
        m.display_name.toLowerCase().includes(query) ||
        (m.email && m.email.toLowerCase().includes(query))
    ).slice(0, 10); // Limit to 10 suggestions

    if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<div style="padding: 10px; color: #888;">No members found</div>';
        suggestionsDiv.style.display = 'block';
        return;
    }

    suggestionsDiv.innerHTML = matches.map(m => `
        <div class="member-suggestion" data-id="${m.id}" data-name="${m.display_name}" data-email="${m.email || ''}"
             style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;"
             onmouseover="this.style.background='#f0f7ff'"
             onmouseout="this.style.background='white'">
            <strong>${m.display_name}</strong>
            ${m.email ? '<br><small style="color: #666;">' + m.email + '</small>' : ''}
        </div>
    `).join('');

    suggestionsDiv.style.display = 'block';

    // Add click handlers
    suggestionsDiv.querySelectorAll('.member-suggestion').forEach(el => {
        el.addEventListener('click', () => selectMember(el.dataset.id, el.dataset.name, el.dataset.email));
    });
});

// Hide suggestions when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.submitter-info')) {
        suggestionsDiv.style.display = 'none';
    }
});

function selectMember(id, name, email) {
    selectedMemberId = id;
    document.getElementById('submitter-member-id').value = id;
    document.getElementById('submitter-name').value = name;
    document.getElementById('submitter-email').value = email;

    document.getElementById('submitter-search').style.display = 'none';
    document.getElementById('selected-member').style.display = 'block';
    document.getElementById('selected-member-text').textContent = name + (email ? ' (' + email + ')' : '');
    suggestionsDiv.style.display = 'none';
}

function clearMember() {
    selectedMemberId = null;
    document.getElementById('submitter-member-id').value = '';
    document.getElementById('submitter-name').value = '';
    document.getElementById('submitter-email').value = '';
    document.getElementById('submitter-search').value = '';
    document.getElementById('submitter-search').style.display = 'block';
    document.getElementById('selected-member').style.display = 'none';
    document.getElementById('submitter-search').focus();
}

// Try to get member info from Wild Apricot context
function tryPopulateFromWA() {
    try {
        if (window.WA && window.WA.Contact) {
            const contact = window.WA.Contact;
            const name = (contact.FirstName || '') + ' ' + (contact.LastName || '');
            const email = contact.Email || '';
            const id = contact.Id || '';

            if (name.trim()) {
                selectMember(id, name.trim(), email);
            }
        }
    } catch (e) {
        console.log('Not in WA context, manual entry required');
    }
}

// Try to populate on load
tryPopulateFromWA();
setTimeout(tryPopulateFromWA, 500);

// Event data cache
let eventList = [];

// Load events for autocomplete
fetch('/api/events.json')
    .then(r => r.json())
    .then(events => {
        eventList = events;
        console.log(`Loaded ${events.length} events for autocomplete`);
    })
    .catch(e => console.log('Event list not available'));

// Event search autocomplete
const eventSearchInput = document.getElementById('event-search');
const eventSuggestionsDiv = document.getElementById('event-suggestions');

eventSearchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();

    if (query.length < 2) {
        eventSuggestionsDiv.style.display = 'none';
        return;
    }

    // Filter events matching the query (name or date)
    const matches = eventList.filter(e =>
        e.name.toLowerCase().includes(query) ||
        e.date.includes(query)
    ).slice(0, 15); // Limit to 15 suggestions

    if (matches.length === 0) {
        eventSuggestionsDiv.innerHTML = '<div style="padding: 10px; color: #888;">No events found. Leave blank to auto-match.</div>';
        eventSuggestionsDiv.style.display = 'block';
        return;
    }

    eventSuggestionsDiv.innerHTML = matches.map(e => `
        <div class="event-suggestion" data-id="${e.id}" data-name="${e.name}" data-date="${e.date}"
             style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;"
             onmouseover="this.style.background='#f0f7ff'"
             onmouseout="this.style.background='white'">
            <strong>${e.name}</strong>
            <br><small style="color: #666;">${e.date}</small>
        </div>
    `).join('');

    eventSuggestionsDiv.style.display = 'block';

    // Add click handlers
    eventSuggestionsDiv.querySelectorAll('.event-suggestion').forEach(el => {
        el.addEventListener('click', () => selectEvent(el.dataset.id, el.dataset.name, el.dataset.date));
    });
});

// Hide event suggestions when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.event-select')) {
        eventSuggestionsDiv.style.display = 'none';
    }
});

function selectEvent(id, name, date) {
    document.getElementById('event-id').value = id;
    document.getElementById('event-search').style.display = 'none';
    document.getElementById('selected-event').style.display = 'block';
    document.getElementById('selected-event-text').textContent = name + ' (' + date + ')';
    eventSuggestionsDiv.style.display = 'none';
}

function clearEvent() {
    document.getElementById('event-id').value = '';
    document.getElementById('event-search').value = '';
    document.getElementById('event-search').style.display = 'block';
    document.getElementById('selected-event').style.display = 'none';
}

// Drop zone events
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('click', () => {
    if (!consentGiven) {
        alert('Please agree to the Photo Submission Terms before uploading.');
        return;
    }
    fileInput.click();
});

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    if (!consentGiven) {
        alert('Please agree to the Photo Submission Terms before uploading.');
        return;
    }
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    if (!consentGiven) {
        e.target.value = '';
        return;
    }
    handleFiles(e.target.files);
});

function handleFiles(files) {
    // Standard image MIME types
    const validTypes = ['image/jpeg', 'image/png', 'image/heic', 'image/heif', 'image/tiff', 'image/webp', 'image/bmp'];

    // RAW and other extensions to accept (browsers don't recognize RAW MIME types)
    const validExtensions = [
        '.jpg', '.jpeg', '.png', '.heic', '.heif', '.tiff', '.tif', '.webp', '.bmp',
        '.nef', '.nrw', '.cr2', '.cr3', '.arw', '.srf', '.raf', '.orf', '.rw2', '.pef', '.dng', '.raw'
    ];

    for (let file of files) {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        if (validTypes.includes(file.type) || validExtensions.includes(ext)) {
            selectedFiles.push(file);
        }
    }

    updatePreview();
}

function updatePreview() {
    const container = document.getElementById('preview-container');
    const grid = document.getElementById('preview-grid');
    const count = document.getElementById('file-count');

    grid.innerHTML = '';
    count.textContent = selectedFiles.length;

    if (selectedFiles.length > 0) {
        container.classList.add('has-files');

        selectedFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.dataset.index = index;

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);

            const remove = document.createElement('button');
            remove.className = 'remove';
            remove.innerHTML = '√ó';
            remove.onclick = () => removeFile(index);

            const status = document.createElement('div');
            status.className = 'status pending';
            status.textContent = 'Ready';

            item.appendChild(img);
            item.appendChild(remove);
            item.appendChild(status);
            grid.appendChild(item);
        });
    } else {
        container.classList.remove('has-files');
    }
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
}

function clearFiles() {
    selectedFiles = [];
    updatePreview();
}

async function uploadFiles() {
    if (selectedFiles.length === 0) return;

    // Validate submitter info - must select from member list
    const submitterMemberId = document.getElementById('submitter-member-id').value;
    const submitterName = document.getElementById('submitter-name').value.trim();
    const submitterEmail = document.getElementById('submitter-email').value.trim();

    if (!submitterMemberId || !submitterName) {
        alert('Please select your name from the member list.');
        document.getElementById('submitter-search').focus();
        return;
    }

    const eventId = document.getElementById('event-id').value;
    const uploadBtn = document.getElementById('upload-btn');
    const progress = document.getElementById('upload-progress');

    uploadBtn.disabled = true;
    progress.classList.add('visible');

    let completed = 0;
    let failed = 0;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const item = document.querySelector(`.preview-item[data-index="${i}"]`);
        const status = item.querySelector('.status');

        status.className = 'status uploading';
        status.textContent = 'Uploading...';

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('submitter_member_id', submitterMemberId);
            formData.append('submitter_name', submitterName);
            formData.append('submitter_email', submitterEmail);
            if (eventId) formData.append('event_id', eventId);

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                status.className = 'status success';
                status.textContent = 'Done!';
                completed++;
            } else {
                status.className = 'status error';
                status.textContent = 'Error';
                failed++;
            }
        } catch (error) {
            status.className = 'status error';
            status.textContent = 'Error';
            failed++;
        }

        // Update progress
        const percent = ((i + 1) / selectedFiles.length) * 100;
        document.getElementById('progress-fill').style.width = percent + '%';
        document.getElementById('progress-text').textContent =
            `Uploaded ${i + 1} of ${selectedFiles.length}`;
    }

    // Show success
    document.getElementById('success-text').textContent =
        `${completed} photo${completed !== 1 ? 's' : ''} uploaded successfully${failed > 0 ? `, ${failed} failed` : ''}.`;
    document.getElementById('upload-form').style.display = 'none';
    document.getElementById('success-message').classList.add('visible');
}

function resetForm() {
    selectedFiles = [];
    consentGiven = false;
    document.getElementById('file-input').value = '';
    document.getElementById('consent-checkbox').checked = false;
    document.getElementById('drop-zone').classList.add('disabled');
    document.getElementById('consent-reminder').style.display = 'block';
    document.getElementById('upload-form').style.display = 'block';
    document.getElementById('success-message').classList.remove('visible');
    document.getElementById('upload-progress').classList.remove('visible');
    document.getElementById('preview-container').classList.remove('has-files');
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('upload-btn').disabled = false;
    // Clear event selection
    clearEvent();
    // Note: Don't clear member - they're likely uploading more of their own photos
}
</script>

</body>
</html>
