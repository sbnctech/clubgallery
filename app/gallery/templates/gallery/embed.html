<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title>SBNC Photo Gallery</title>

    <!-- jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

    <!-- nanogallery2 -->
    <link href="https://cdn.jsdelivr.net/npm/nanogallery2@3/dist/css/nanogallery2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nanogallery2@3/dist/jquery.nanogallery2.min.js"></script>

    <!-- Select2 for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #fff;
            color: #333;
        }

        /* Compact header for iframe */
        .gallery-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3d6f 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .gallery-title {
            font-size: 20px;
            font-weight: 600;
        }
        .gallery-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Filter bar - compact */
        .filter-bar {
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        .filter-group.member-search {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
        }
        .filter-group label {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-group select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        .filter-group select:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        /* Select2 compact */
        .select2-container--default .select2-selection--single {
            height: 36px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px;
            font-size: 14px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 34px;
        }
        .select2-results__option { padding: 8px 10px; }
        .select2-results__option--highlighted { background-color: #2c5aa0 !important; }

        .btn-clear {
            padding: 8px 14px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            color: #666;
        }
        .btn-clear:hover { background: #f0f0f0; }

        /* Active filters */
        .active-filters {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            padding: 0 20px 12px;
            background: #f8f9fa;
        }
        .active-filters:empty { display: none; }
        .filter-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .filter-tag .remove {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.7;
            font-size: 14px;
        }
        .filter-tag .remove:hover { opacity: 1; }
        .filter-tag.person { background: #fce4ec; color: #c2185b; }
        .filter-tag.event { background: #e8f5e9; color: #2e7d32; }

        /* Results bar */
        .results-bar {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #666;
            border-bottom: 1px solid #eee;
        }
        .results-bar strong { color: #333; }
        .view-mode {
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Gallery container */
        .gallery-container {
            padding: 15px;
            min-height: 300px;
        }

        /* Member option */
        .member-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .member-option img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        .member-option .name { font-weight: 500; font-size: 14px; }
        .member-option .count { color: #888; font-size: 11px; }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-top-color: #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .gallery-header { padding: 12px 15px; }
            .gallery-title { font-size: 18px; }
            .filter-bar { padding: 10px 15px; flex-direction: column; align-items: stretch; }
            .filter-group { width: 100%; min-width: unset; }
            .filter-group.member-search { max-width: 100%; }
            .gallery-container { padding: 10px; }
        }

        /* Nanogallery overrides for cleaner look */
        .nGY2 .nGY2Gallery { background: transparent !important; }
    </style>
</head>
<body>

<div class="gallery-header">
    <div>
        <div class="gallery-title">SBNC Photo Gallery</div>
        <div class="gallery-subtitle">Santa Barbara Newcomers Club Events</div>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-group member-search">
        <label>Find Member</label>
        <select id="member-search">
            <option value="">Search members...</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Activity</label>
        <select id="filter-activity">
            <option value="">All Activities</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Event</label>
        <select id="filter-event">
            <option value="">All Events</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Year</label>
        <select id="filter-year">
            <option value="">All Years</option>
        </select>
    </div>
    <button class="btn-clear" onclick="clearFilters()">Clear</button>
</div>

<div class="active-filters" id="active-filters"></div>

<div class="results-bar">
    <div id="results-count">Loading...</div>
    <div class="view-mode" id="view-mode">Browse Events</div>
</div>

<div class="gallery-container">
    <div id="gallery">
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>Loading photos...</div>
        </div>
    </div>
</div>

<script>
// Configuration - can be overridden by parent frame
const CONFIG = {
    apiBase: window.SBNC_API_BASE || '',
    photosBase: window.SBNC_PHOTOS_BASE || '/photos'
};

let members = [], activities = [], events = [];
let currentFilters = { member: null, activity: null, event: null, year: null };

$(document).ready(function() {
    Promise.all([
        fetch(CONFIG.apiBase + '/api/members.json').then(r => r.json()).catch(() => []),
        fetch(CONFIG.apiBase + '/api/activities.json').then(r => r.json()).catch(() => []),
        fetch(CONFIG.apiBase + '/api/events.json').then(r => r.json()).catch(() => [])
    ]).then(([m, a, e]) => {
        members = m; activities = a; events = e;
        populateFilters();
        initMemberSearch();
        loadGallery();
    });

    $('#filter-activity, #filter-event, #filter-year').on('change', applyFilters);
});

function populateFilters() {
    activities.forEach(a => {
        $('#filter-activity').append(`<option value="${a.id}">${a.name}</option>`);
    });

    const years = [...new Set(events.map(e => e.date?.substring(0, 4)).filter(Boolean))].sort().reverse();
    years.forEach(y => $('#filter-year').append(`<option value="${y}">${y}</option>`));

    let currentYear = null;
    events.forEach(e => {
        const year = e.date?.substring(0, 4);
        if (year && year !== currentYear) {
            $('#filter-event').append(`<optgroup label="${year}">`);
            currentYear = year;
        }
        $('#filter-event').append(`<option value="${e.id}">${e.name}</option>`);
    });
}

function initMemberSearch() {
    $('#member-search').select2({
        placeholder: 'Search members...',
        allowClear: true,
        minimumInputLength: 1,
        data: members.map(m => ({ id: m.id, text: m.name, photoCount: m.photoCount, thumb: m.thumb })),
        templateResult: m => m.id ? $(`<div class="member-option">
            <img src="${m.thumb || CONFIG.photosBase + '/default-avatar.png'}">
            <div><div class="name">${m.text}</div><div class="count">${m.photoCount} photos</div></div>
        </div>`) : m.text,
        templateSelection: m => m.text || 'Search members...'
    }).on('change', applyFilters);
}

function applyFilters() {
    currentFilters = {
        member: $('#member-search').val() || null,
        activity: $('#filter-activity').val() || null,
        event: $('#filter-event').val() || null,
        year: $('#filter-year').val() || null
    };
    updateActiveFilters();
    loadGallery();
}

function updateActiveFilters() {
    const $c = $('#active-filters').empty();
    if (currentFilters.member) {
        const m = members.find(x => x.id === currentFilters.member);
        if (m) $c.append(`<span class="filter-tag person">${m.name}<span class="remove" onclick="removeFilter('member')">×</span></span>`);
    }
    if (currentFilters.activity) $c.append(`<span class="filter-tag">${currentFilters.activity}<span class="remove" onclick="removeFilter('activity')">×</span></span>`);
    if (currentFilters.event) {
        const e = events.find(x => x.id === currentFilters.event);
        if (e) $c.append(`<span class="filter-tag event">${e.name}<span class="remove" onclick="removeFilter('event')">×</span></span>`);
    }
    if (currentFilters.year) $c.append(`<span class="filter-tag">${currentFilters.year}<span class="remove" onclick="removeFilter('year')">×</span></span>`);
}

function removeFilter(type) {
    currentFilters[type] = null;
    if (type === 'member') $('#member-search').val(null).trigger('change.select2');
    else $(`#filter-${type}`).val('');
    applyFilters();
}

function clearFilters() {
    currentFilters = { member: null, activity: null, event: null, year: null };
    $('#member-search').val(null).trigger('change.select2');
    $('#filter-activity, #filter-event, #filter-year').val('');
    updateActiveFilters();
    loadGallery();
}

function loadGallery() {
    const params = new URLSearchParams();
    if (currentFilters.member) params.set('member', currentFilters.member);
    if (currentFilters.activity) params.set('activity', currentFilters.activity);
    if (currentFilters.event) params.set('event', currentFilters.event);
    if (currentFilters.year) params.set('year', currentFilters.year);

    const url = CONFIG.apiBase + '/api/gallery.json?' + params.toString();

    let viewMode = 'Browse Events';
    if (currentFilters.event) viewMode = 'Event Photos';
    else if (currentFilters.member) viewMode = 'Member Photos';
    else if (currentFilters.activity) viewMode = 'Activity Events';
    else if (currentFilters.year) viewMode = currentFilters.year + ' Events';
    $('#view-mode').text(viewMode);

    try { $('#gallery').nanogallery2('destroy'); } catch(e) {}

    $('#gallery').nanogallery2({
        items: url,
        itemsBaseURL: '',
        thumbnailWidth: 'auto',
        thumbnailHeight: 180,
        thumbnailBorderHorizontal: 0,
        thumbnailBorderVertical: 0,
        thumbnailGutterWidth: 8,
        thumbnailGutterHeight: 8,
        thumbnailLabel: { display: true, position: 'overImageOnBottom', hideIcons: true },
        thumbnailHoverEffect2: 'imageScale150',
        galleryDisplayMode: 'rows',
        galleryMaxRows: 20,
        viewerToolbar: { display: true, standard: 'previousButton,label,nextButton' },
        fnGalleryRenderEnd: function(items) {
            const type = currentFilters.event ? 'photos' : 'events';
            $('#results-count').html(`<strong>${items.length}</strong> ${type}`);
        }
    });
}

// Notify parent frame of height changes for auto-resize
function notifyHeight() {
    if (window.parent !== window) {
        window.parent.postMessage({ type: 'sbnc-gallery-height', height: document.body.scrollHeight }, '*');
    }
}
new ResizeObserver(notifyHeight).observe(document.body);
</script>

</body>
</html>
