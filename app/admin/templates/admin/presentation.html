{% extends "admin/base.html" %}

{% block title %}Gallery Presentation - SBNC Photo Admin{% endblock %}

{% block extra_css %}
<style>
.presentation-container {
    max-width: 1000px;
}

.presentation-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.presentation-section h3 {
    margin: 0 0 5px;
    color: #333;
}

.presentation-section .section-desc {
    color: #666;
    font-size: 14px;
    margin: 0 0 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
}

.checkbox-item:hover {
    background: #e9ecef;
}

.checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-item label {
    cursor: pointer;
    font-weight: 500;
}

.checkbox-item .hint {
    font-size: 12px;
    color: #888;
    margin-left: auto;
}

/* Activity list */
.activity-list {
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    background: white;
    transition: background 0.2s;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item:hover {
    background: #f8f9fa;
}

.activity-item.hidden-activity {
    background: #f8f9fa;
    opacity: 0.6;
}

.activity-item .drag-handle {
    cursor: grab;
    color: #999;
    font-size: 18px;
}

.activity-item .drag-handle:active {
    cursor: grabbing;
}

.activity-item .activity-name {
    flex: 1;
    font-weight: 500;
}

.activity-item .activity-stats {
    font-size: 13px;
    color: #666;
}

.activity-item .activity-toggle {
    width: 18px;
    height: 18px;
}

.activity-item input.custom-name {
    width: 150px;
    padding: 5px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.activity-item input.custom-name:focus {
    border-color: #2c5aa0;
    outline: none;
}

.activity-item input.custom-name::placeholder {
    color: #bbb;
    font-style: italic;
}

/* Default view */
.default-view-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.form-group {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: 5px;
    color: #333;
}

.form-group select,
.form-group input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.form-group .hint {
    font-size: 12px;
    color: #888;
    margin-top: 3px;
}

/* Featured events */
.featured-events {
    margin-top: 15px;
}

.featured-events-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
}

.featured-event-tag {
    display: inline-flex;
    align-items: center;
    background: #fff3cd;
    color: #856404;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
}

.featured-event-tag .remove {
    margin-left: 8px;
    cursor: pointer;
    font-weight: bold;
    opacity: 0.7;
}

.featured-event-tag .remove:hover {
    opacity: 1;
}

.add-featured {
    display: flex;
    gap: 10px;
}

.add-featured select {
    flex: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

/* Form actions */
.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.btn-reset {
    background: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
}

/* Preview panel */
.preview-panel {
    background: #2c5aa0;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.preview-panel h3 {
    margin: 0 0 10px;
    font-size: 16px;
}

.preview-panel p {
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
}

.preview-link {
    display: inline-block;
    margin-top: 10px;
    color: white;
    text-decoration: underline;
}

.unsaved-warning {
    display: none;
    background: #fff3cd;
    border: 1px solid #ffc107;
    color: #856404;
    padding: 10px 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}

.unsaved-warning.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="presentation-container">
    <h2>Gallery Presentation</h2>
    <p style="color: #666; margin-bottom: 20px;">Configure what members see when viewing the photo gallery.</p>

    <div class="preview-panel">
        <h3>Preview Changes</h3>
        <p>After saving, view the gallery to see your changes in action.</p>
        <a href="{{ url_for('gallery.gallery_page') }}" target="_blank" class="preview-link">Open Gallery in New Tab &rarr;</a>
    </div>

    <div id="unsavedWarning" class="unsaved-warning">
        You have unsaved changes. Don't forget to save!
    </div>

    <form id="presentationForm" method="POST">
        <!-- Filter Visibility -->
        <div class="presentation-section">
            <h3>Filter Controls</h3>
            <p class="section-desc">Choose which filters appear in the gallery toolbar.</p>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="filter_member" name="filter_member"
                           {% if config.presentation.filters.showMemberSearch %}checked{% endif %}>
                    <label for="filter_member">Member Search</label>
                    <span class="hint">Find photos of a person</span>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="filter_activity" name="filter_activity"
                           {% if config.presentation.filters.showActivityFilter %}checked{% endif %}>
                    <label for="filter_activity">Activity Filter</label>
                    <span class="hint">Filter by activity group</span>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="filter_event" name="filter_event"
                           {% if config.presentation.filters.showEventFilter %}checked{% endif %}>
                    <label for="filter_event">Event Filter</label>
                    <span class="hint">Jump to specific event</span>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="filter_year" name="filter_year"
                           {% if config.presentation.filters.showYearFilter %}checked{% endif %}>
                    <label for="filter_year">Year Filter</label>
                    <span class="hint">Filter by year</span>
                </div>
            </div>
        </div>

        <!-- Activity Groups -->
        <div class="presentation-section">
            <h3>Activity Groups</h3>
            <p class="section-desc">Show or hide activity groups. Uncheck to hide from the gallery.</p>

            <div class="activity-list" id="activityList">
                {% for activity in activities %}
                <div class="activity-item {% if activity.id in config.presentation.activityGroups.hidden %}hidden-activity{% endif %}"
                     data-activity-id="{{ activity.id }}">
                    <span class="drag-handle">&#9776;</span>
                    <input type="checkbox" class="activity-toggle" name="activity_visible_{{ activity.id }}"
                           {% if activity.id not in config.presentation.activityGroups.hidden %}checked{% endif %}>
                    <span class="activity-name">{{ activity.name }}</span>
                    <input type="text" class="custom-name" name="activity_name_{{ activity.id }}"
                           placeholder="Custom name..."
                           value="{{ config.presentation.activityGroups.customNames.get(activity.id, '') }}">
                    <span class="activity-stats">{{ activity.eventCount }} events, {{ activity.photoCount }} photos</span>
                </div>
                {% endfor %}
            </div>
            <input type="hidden" name="activity_order" id="activityOrder" value="">
        </div>

        <!-- Default View -->
        <div class="presentation-section">
            <h3>Default View</h3>
            <p class="section-desc">Set what members see when the gallery first loads.</p>

            <div class="default-view-grid">
                <div class="form-group">
                    <label for="default_activity">Default Activity</label>
                    <select id="default_activity" name="default_activity">
                        <option value="">All Activities</option>
                        {% for activity in activities %}
                        <option value="{{ activity.id }}"
                                {% if config.presentation.defaultView.activity == activity.id %}selected{% endif %}>
                            {{ activity.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="hint">Pre-filter to this activity on load</div>
                </div>

                <div class="form-group">
                    <label for="default_year">Default Year</label>
                    <select id="default_year" name="default_year">
                        <option value="">All Years</option>
                        {% for year in years %}
                        <option value="{{ year }}"
                                {% if config.presentation.defaultView.year == year %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="hint">Pre-filter to this year on load</div>
                </div>

                <div class="form-group">
                    <label for="recent_months">Recent Events Only</label>
                    <input type="number" id="recent_months" name="recent_months"
                           value="{{ config.presentation.defaultView.recentMonths or 0 }}"
                           min="0" max="36">
                    <div class="hint">0 = show all, or # months to include</div>
                </div>
            </div>
        </div>

        <!-- Header Display -->
        <div class="presentation-section">
            <h3>Header Display</h3>
            <p class="section-desc">Control the gallery header appearance.</p>

            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="show_header" name="show_header"
                           {% if config.presentation.header.show %}checked{% endif %}>
                    <label for="show_header">Show Header</label>
                    <span class="hint">Gallery title and description</span>
                </div>

                <div class="checkbox-item">
                    <input type="checkbox" id="show_subtitle" name="show_subtitle"
                           {% if config.presentation.header.showSubtitle %}checked{% endif %}>
                    <label for="show_subtitle">Show Subtitle</label>
                    <span class="hint">Description below title</span>
                </div>
            </div>
        </div>

        <!-- Featured Events -->
        <div class="presentation-section">
            <h3>Featured Events</h3>
            <p class="section-desc">Pin important events to appear at the top of the gallery.</p>

            <div class="checkbox-item" style="margin-bottom: 15px; display: inline-flex;">
                <input type="checkbox" id="show_featured" name="show_featured"
                       {% if config.presentation.featured.showFeaturedSection %}checked{% endif %}>
                <label for="show_featured">Show Featured Section</label>
            </div>

            <div class="featured-events">
                <div class="featured-events-list" id="featuredEventsList">
                    {% for event_id in config.presentation.featured.pinnedEvents %}
                    {% set event = events_by_id.get(event_id) %}
                    {% if event %}
                    <span class="featured-event-tag" data-event-id="{{ event_id }}">
                        {{ event.name }}
                        <span class="remove" onclick="removeFeaturedEvent('{{ event_id }}')">&times;</span>
                    </span>
                    {% endif %}
                    {% endfor %}
                </div>

                <div class="add-featured">
                    <select id="addFeaturedSelect">
                        <option value="">Select an event to feature...</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.name }} ({{ event.date[:10] if event.date else 'No date' }})</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="addFeaturedEvent()">Add</button>
                </div>
                <input type="hidden" name="pinned_events" id="pinnedEvents"
                       value="{{ config.presentation.featured.pinnedEvents | join(',') }}">
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large">Save Presentation</button>
            <button type="button" class="btn btn-reset" onclick="resetPresentation()">Reset to Defaults</button>
        </div>
    </form>
</div>

<script>
// Track unsaved changes
let hasChanges = false;
const form = document.getElementById('presentationForm');
const warning = document.getElementById('unsavedWarning');

form.addEventListener('input', markChanged);
form.addEventListener('change', markChanged);

function markChanged() {
    hasChanges = true;
    warning.classList.add('show');
}

form.addEventListener('submit', function() {
    // Update activity order before submit
    updateActivityOrder();
    hasChanges = false;
});

window.addEventListener('beforeunload', function(e) {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Activity ordering
function updateActivityOrder() {
    const items = document.querySelectorAll('.activity-item');
    const order = Array.from(items).map(item => item.dataset.activityId);
    document.getElementById('activityOrder').value = order.join(',');
}

// Toggle activity visibility styling
document.querySelectorAll('.activity-toggle').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const item = this.closest('.activity-item');
        item.classList.toggle('hidden-activity', !this.checked);
    });
});

// Featured events management
let pinnedEvents = {{ config.presentation.featured.pinnedEvents | tojson }};

function addFeaturedEvent() {
    const select = document.getElementById('addFeaturedSelect');
    const eventId = select.value;
    if (!eventId || pinnedEvents.includes(eventId)) return;

    const eventName = select.options[select.selectedIndex].text;
    pinnedEvents.push(eventId);

    const tag = document.createElement('span');
    tag.className = 'featured-event-tag';
    tag.dataset.eventId = eventId;
    tag.innerHTML = `${eventName.split(' (')[0]} <span class="remove" onclick="removeFeaturedEvent('${eventId}')">&times;</span>`;

    document.getElementById('featuredEventsList').appendChild(tag);
    document.getElementById('pinnedEvents').value = pinnedEvents.join(',');
    select.value = '';
    markChanged();
}

function removeFeaturedEvent(eventId) {
    pinnedEvents = pinnedEvents.filter(id => id !== eventId);
    const tag = document.querySelector(`.featured-event-tag[data-event-id="${eventId}"]`);
    if (tag) tag.remove();
    document.getElementById('pinnedEvents').value = pinnedEvents.join(',');
    markChanged();
}

function resetPresentation() {
    if (confirm('Reset all presentation settings to defaults?')) {
        fetch('{{ url_for("admin.reset_presentation") }}', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }
}

// Simple drag-and-drop for activity reordering
let draggedItem = null;

document.querySelectorAll('.drag-handle').forEach(handle => {
    const item = handle.closest('.activity-item');

    handle.addEventListener('mousedown', function(e) {
        draggedItem = item;
        item.style.opacity = '0.5';
    });
});

document.addEventListener('mouseup', function() {
    if (draggedItem) {
        draggedItem.style.opacity = '1';
        draggedItem = null;
        updateActivityOrder();
        markChanged();
    }
});

document.querySelectorAll('.activity-item').forEach(item => {
    item.addEventListener('mouseover', function() {
        if (draggedItem && draggedItem !== this) {
            const list = document.getElementById('activityList');
            const items = Array.from(list.children);
            const draggedIndex = items.indexOf(draggedItem);
            const targetIndex = items.indexOf(this);

            if (draggedIndex < targetIndex) {
                list.insertBefore(draggedItem, this.nextSibling);
            } else {
                list.insertBefore(draggedItem, this);
            }
        }
    });
});
</script>
{% endblock %}
